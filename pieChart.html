<!DOCTYPE html>
<html>
<head>
  <link href="graph.css?" rel="stylesheet">
  <script>

  class Graph {

    constructor(props) {
      this.container = props.container;
      this.randId = Math.floor(Math.random() * 10000);
      this.type = props.type;
      this.title = props.title ? props.title : "";
      this.data = props.data ? props.data : [];
      this.size = props.size ? props.size : 200;
      this.graphKey = props.graphKey ? props.graphKey : false;
      this.barColorSet = [];
      this.graphKeyValues = [];
      this.hideValues = props.hideValues ? props.hideValues : false;
      this.animate = props.animate ? props.animate : false;
      this.graphKeyTitle = props.graphKeyTitle ? props.graphKeyTitle  : "Key";
      if(this.type == "pie") {
        this.generatePieChart();
        this.container.style.height = this.size + 130 + "px";
      }
    }

    generatePieChart() {

      this.container.innerHTML = "<div class='pie pie"+this.randId+"' style='height:" +  this.size+ "px;width:" + this.size + "px;z-'><div class='pie_segment animateSegment animateSegment"+this.randId+"' style='--rotation:180;'></div><div class='pie_segment animateSegment animateSegment"+this.randId+"' style='--rotation:0;'></div></div><div class='pieLabelsContainer pieLabelsContainer"+this.randId+"' style='height:" +  this.size + "px;width:" + this.size + "px;'></div><div class='titleAndKeyContainer titleAndKeyContainer"+this.randId+"' style='height:" +  this.size + "px;width:" + this.size + "px;'></div>";

      var totalValue = 0;
      for (let obj in this.data) {
        totalValue += this.data[obj].value;
        this.graphKeyValues.push(obj);
        this.barColorSet.push(this.data[obj].color);
      }

      var rotation = 0;
      for (let obj in this.data) {
        let percentage = ((this.data[obj].value / totalValue) * 100).toFixed(1);
        if (percentage != "undefined" && percentage > 0 && percentage <= 100) {
          let addedDegree = 0;
          let degrees = 360 * (.01 * percentage);
          if (percentage > 50) {
            degrees = 360 * (.01 * (percentage - 50));
          }
          if(percentage > 50 && percentage < 100){
              addedDegree = 3;
          }
          let textRotation = 0;
          let textAlign = "right";
          let textPos = "right";
          if (rotation < 180) {
             textRotation = 180;
             textAlign = "left";
             textPos = "left";
          }
          let textBottom = "5%";
          if (percentage < 5) {
            if(this.size >= 200) {
              textBottom = "-5%";
            }
            if(this.size >= 250) {
              textBottom = "-4.5%";
            }
            if(this.size >= 300) {
              textBottom = "-4%";
            }
            if(this.size >= 350) {
              textBottom = "-3.5%";
            }
            if(this.size >= 400) {
              textBottom = "-3%";
            }
            if(this.size >= 450) {
              textBottom = "-2.5%";
            }
            if(this.size >= 500) {
              textBottom = "-2%";
            }
            if(this.size >= 550) {
              textBottom = "-1.5%";
            }
          }

          let labelRotation = 90 - rotation;
          if (rotation >= 180) {
            labelRotation = 270 - rotation;
          }

          let labelTransformOrigin = "0% 100%";
          if (rotation >= 180) {
            labelTransformOrigin = "100% 0%";
          }

          document.querySelector(".pie"+this.randId).innerHTML += "<div class=pie_segment style='--degrees: " + (degrees + addedDegree) + "; --rotation: " + rotation + "; --bg:" + this.data[obj].color + ";'></div>";

          if(this.hideValues == false) {
            document.querySelector(".pieLabelsContainer"+this.randId).innerHTML += "<div class=invisibleSegment style='--degrees: " + (degrees + addedDegree) + "; --rotation: " + rotation + ";'><div class=pieLabel style='transform:rotate( " + textRotation + "deg);text-align:" + textAlign + ";bottom:" + textBottom + "'><div style='transform:rotate("+labelRotation+"deg);transform-origin:"+labelTransformOrigin+";'><div class='labelName' style='"+textPos+":102%;' >" + obj + ": <b>" + percentage + "%</b><br>" + this.data[obj].value + "</div><div class='pointerLine'></div></div></div></div>";
          }
          rotation += degrees;
          if (percentage > 50) {
            degrees = 360 * (.01 * (percentage - (percentage - 50)));
            document.querySelector(".pie"+this.randId).innerHTML += "<div class=pie_segment style='--degrees: " + degrees + "; --rotation: " + rotation + "; --bg:" + this.data[obj].color + ";'></div>";
            document.querySelector(".pieLabelsContainer"+this.randId).innerHTML += "<div class=invisibleSegment style='--degrees: " + degrees + "; --rotation: " + rotation + ";bottom:" + textBottom + "'></div>";
            rotation += degrees;
          }
          if(this.barColorSet.length > 1) {
            let lineMargin = 0;
            if (rotation == 180) {
              lineMargin = 1;
            }
            document.querySelector(".pie"+this.randId).innerHTML += "<div class='pieBorder' style='margin-left:"+lineMargin+"px;transform:rotate(" + rotation + "deg);'></div>";
          }
        }
      }

      if (this.title != "") {
        document.querySelector(".titleAndKeyContainer"+this.randId).innerHTML += "<div class='pieTitleAndKeyContainer'>" + this.title + "</div>";
      }

      if (this.graphKey) {
        var graphKey = "<div class=graphKeyContainer style='width:100%;margin-left:0px;position:absolute;top:" + (this.size + 40) + "px;'><div style=float:left;width:100%;>" + this.graphKeyTitle + ":</div>";
        this.graphKeyValues.map( (value, key) => {
          graphKey += "<div class='keySection'><div class='keySquare' onMouseOver=showData("+key+","+this.randId+") onMouseOut=showAllData("+this.randId+") style=background:" + this.barColorSet[key] + "></div><div class='keyText'>" + value + "</div></div>";
        });
        graphKey += "</div>";
        document.querySelector(".titleAndKeyContainer"+this.randId).innerHTML += graphKey;
      }

      if (this.animate == true) {
        setTimeout(() => {
          animatePieChart(1, 180, 360, 0, this.randId)
        },0);
      } else {
        document.querySelector('.pie'+this.randId).removeChild(document.querySelector('.pie'+this.randId).childNodes[0]);
        document.querySelector('.pie'+this.randId).removeChild(document.querySelector('.pie'+this.randId).childNodes[0]);
      }
    }
  }

  var animatePieChart = (index, degrees, target, rotation, randId) => {
    if (degrees > target) {
      if(index == 1){
        animatePieChart(0, 180 , 360, 180, randId);
      } else {
        document.querySelector('.pie'+randId).removeChild(document.querySelector('.pie'+randId).childNodes[0]);
        document.querySelector('.pie'+randId).removeChild(document.querySelector('.pie'+randId).childNodes[0]);
      }
      return;
    }
    document.querySelectorAll(".animateSegment"+randId)[index].setAttribute("style","z-index:10;--degrees:" + degrees + "; --rotation: " + rotation + "; --bg:white;");
    setTimeout(function(){
      animatePieChart(index, degrees + 1.5, target, rotation, randId)
    },0);
  }

  </script>
</head>
<body>
  <div id="container"></div>
</body>
<script>

var graphProperties = {
  container: document.getElementById("container"),
  type: "pie",
  size: 300,
  title: "My Graph",
  graphKeyTitle: "People",
  graphKey: true,
  animate: true,
  hideValues: false,
  data: {
    Josh: {
      color: "red",
      value: 23
    },
    Jon: {
      color: "green",
      value: 3
    },
    Steve: {
      color: "pink",
      value: 30
    },
    Mom: {
      color: "cyan",
      value: 17
    },
    Steve: {
      color: "grey",
      value: 40
    },

  }
}
var myGraph = new Graph(graphProperties);

</script>
</html>
